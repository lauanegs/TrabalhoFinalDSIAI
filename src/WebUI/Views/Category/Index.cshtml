@model IEnumerable<Application.ViewModels.CategoryViewModel>

@{
    ViewData["Title"] = "Categorias";
}

<div class="card shadow-sm p-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="m-0">Categorias</h2>
        <a class="btn btn-primary" asp-action="Create">+ Nova Categoria</a>
    </div>

    <!-- Campo de busca -->
    <div class="input-group mb-3">
        <span class="input-group-text">üîç</span>
        <input type="text" id="searchBox" class="form-control" placeholder="Buscar categoria..." />
    </div>

    <div id="tableContainer">
        @await Html.PartialAsync("_CategoryTablePartial", Model)
    </div>
</div>

@section Scripts {
<script>
(() => {

    function debounce(fn, delay) {
        let t;
        return (...args) => {
            clearTimeout(t);
            t = setTimeout(() => fn(...args), delay);
        };
    }

    const url = '@Url.Action("Search", "Category")';
    const searchBox = document.getElementById("searchBox");
    const tableContainer = document.getElementById("tableContainer");

    async function doSearch(term) {
        try {
            const params = new URLSearchParams();
            if (term) params.set("term", term);

            const resp = await fetch(`${url}?${params.toString()}`, {
                method: "GET",
                headers: { "X-Requested-With": "XMLHttpRequest" }
            });

            if (!resp.ok) {
                console.error("Erro ao buscar categorias:", resp.status);
                return;
            }

            const html = await resp.text();
            tableContainer.innerHTML = html;

        } catch (err) {
            console.error("Erro no fetch (Category):", err);
        }
    }

    searchBox.addEventListener("input", debounce(e => doSearch(e.target.value), 300));

})();
</script>
}
